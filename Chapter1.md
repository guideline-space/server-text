# Linuxサーバーの概要
本教科書では、Linuxをインストールし、サーバー環境を構築する実習をしながら、LinuCレベル2の範囲の理解と取得を目指します。第1章では、Linuxサーバーの概要について解説し、2章以降に行う実習に必要な環境と知識の確認を行います。

# 用語集
## Linux
Linus Torvalds氏により開発された、UNIX互換を目指したOSの総称をLinuxといいます。ソースコードは公開されており、世界中の開発者の協力により、日々開発が継続されています。

## ディストリビューション
Linuxは狭い意味ではOSの中心部（＝カーネル）のみを指しますが、Linuxカーネルだけではシステムは動作しません。カーネル以外のさまざまなソフトウェアやインストーラを追加して、利用できるようにしたのがディストリビューションです。ディストリビューションごとに開発方針があり、それに沿ってソフトウェアがまとめられたり、リリースが行われています。

## AlmaLinux
Linuxのディストリビューションの1つです。Red Hat Enterprise Linuxという商用のディストリビューション互換の環境を無償で提供しているディストリビューションで、AlmaLinuxコミュニティによって開発されています。

## IPアドレス 
インターネットにおいて、IPで通信が行われる場合、端末一つ一つにIPアドレスが割り当てられます。IPアドレスとはインターネット上での端末の所在地を示す「住所」にあたります。
現在ではIPv4とIPv6の2種類がありますが、本教科書ではIPv4を使います。

## サブネットマスク
IPアドレスのうちネットワークアドレス部とホストアドレス部を識別するための数値のことをいいます。32ビットのIPアドレスを、8ビット毎に.(ドット)で区切って10進数で表記します。

## ネットワークアドレス 
IPネットワークを小さく分割して利用するときに、ネットワークアドレス部とホストアドレス部に分かれます。ネットワークアドレスの識別に利用されるのが、ネットワークアドレス部です。

## DNSサーバーアドレス 
IPアドレスとFQDN（＝ホスト名＋ドメイン名）の変換を行うのがDNSサービスであり、そのサービスを提供するDNSサーバーのIPアドレスのことです。

## ホスト名
ネットワークに接続されたコンピューターに割り当てられた名称のことをいいます。特定のホストを識別するために使われます。

## ドメイン名
インターネット上に存在するコンピューターやネットワークを識別するために付けらている名前の一種のことをいいます。ドメイン名はアルファベット、数字、一部の記号の組み合わせで構成されますが、日本語.jp のような国際化ドメインも使われるようになっています。

## DVD
光学メディアの1種類で、ビデオ再生での利用で普及し、現在ではデータ記録の用途でも利用されています。約700MBのCD-ROMに比べ、約4.7GBと大容量でも利用できることから、OSのインストールディスクとしても利用されています。

## ハードディスク  
磁気を用いた記憶媒体であり、パソコンの記憶媒体の他、音楽プレーヤー、ビデオなどの記憶媒体としても用いられています。

## SSD  
半導体メモリであるフラッシュメモリを用いた記憶媒体であり、ハードディスクよりも読み書きの処理性能に優れています。

## LVM  
LVM（Logical Volume Manager）とは，複数のハードディスクやパーティションにまたがった記憶領域を一つの論理的なディスクとして扱うことのできるディスク管理の機能のことです。LinuxをはじめとしたUNIX系OS上で利用できます。

##  RAID  
複数のハードディスクをまとめて1台のハードディスクとして管理する技術のことです。
RAIDを使うことによりデータを分散して記録するため、高速化や安全性の向上が期待できます。RAIDの方法には、専用のハードウェアを使う方法（ハードウェアRAID）とソフトウェアで実現する方法（ソフトウェアRAID）があり、高速性や安全性のレベルにより、RAID 0やRAID 5などいくつかの種類があります。

# 実習で利用するハードウェア
本教科書の実習では、市販されているような一般的な構成のPCにLinuxを導入して、その環境上に様々なサーバーを導入し実際に動作させます。この実習で必要な、ハードウェアの仕様は次の通りです。

## マシン本体  
WindowsやLinuxが動作する、いわゆる「パソコン」を想定しています。ただ、実習用のパソコンを用意することが難しい場合には、「VirtualBox」のような仮想マシンソフトウェアを利用して実習環境を用意することもできます。VirutalBoxは、次のURLからダウンロードすることができます。

https://www.virtualbox.org/

## 実装メモリ
AlmaLinux 9.2では1.5GBのメモリが推奨されています。実装メモリが少ない場合はテキストインストールが実行されることがあります。

## DVD光学ドライブ
本教科書の実習では、インストール用DVDを利用するので、光学ドライブがDVDを読み取りできる必要があります。DVDの光学ドライブがない機種では、USB等で接続するDVDドライブを用意するか、USBメモリを利用することもできます。

## USBメモリ
最近のPCではUSBメモリからのブートもサポートしています。そのため、インストールDVDの代わりに、USBメモリを利用することができます。

## ハードディスク
Linuxをインストールするためには記憶装置が必要です。ここでは記憶装置としてハードディスクを使います。必要な容量はインストール時に選択するインストールタイプやインストールするソフトウェアによって異なります。
インストール時にはハードディスクをフォーマット（初期化）するので、ハードディスクの中身は全部消去されます。その為、ハードディスクを削除していいPCを利用するか、バックアップを取ってから作業を行ってください。

## その他周辺機器
本体やDVD、光学ドライブ、ハードディスクドライブの他にも、一般的に利用するためにはキーボード、マウス、ディスプレイ等の周辺機器が必要です。

## 利用するLinuxのディストリビューション
本教科書では、AlmaLinux 9.2の64ビット版を利用します。

https://almalinux.org/ja/

AlmaLinuxは、商用ディストリビューションであるRed Hat Enterprise Linuxをベースにしたディストリビューションとして提供されています。利用に際し費用が発生しない、無償で提供されているディストリビューションです。

# インストール用ISOイメージの入手
AlmaLinuxが配布しているISOイメージを、ダウンロードします。ダウンロードしたISOイメージは、DVDやUSBメモリのライティングソフトウェアを使ってDVD/USBメモリに書き込んでください。データとしてではなく、イメージとして書き込む点に注意してください。
仮想マシンを使う場合には、ISOイメージを仮想光学ドライブにセットすることでインストールが行えるので、インストール用のDVD/USBメモリを作成する必要がありません。

## ダウンロード方法
ISOイメージをダウンロードするには、以下のURLにアクセスします。

https://mirrors.almalinux.org/isos/x86_64/9.2.html

このURLにアクセスすると、多くのミラーサイトが表示されます。例えば、IIJが提供しているミラーサイトのURLであれば次のようになります。

http://ftp.iij.ad.jp/pub/linux/almalinux/9.2/isos/x86_64/

### URLが利用できない場合
URLはサイト構造の変更によって変わっている場合があります。その場合には、AlmaLinuxのWebサイトからリンクを辿ってダウンロードサイトを探してください。

## ISOイメージのファイル名
ISOイメージは以下のようなファイル名になっています。

AlmaLinux-バージョン-アーキテクチャ-イメージの種類.iso

## バージョン
本教科書では、本教科書の作成時点で最新であったAlmaLinux 9.2を利用した構築方法について解説しています。今後のバージョンアップで、より新しいバージョンのAlmaLinuxが入手可能になっているかもしれません。バージョン9系であればマイナーバージョンによる大きな差は無いので同様の手順でサーバーの構築ができると推測されますが、セキュリティ対応などの関係でデフォルトの設定が変更されることで動作が変わる場合があります。

初めて本教科書の内容を学習する際には、まずはバージョンを合わせて動作を確認し、その後異なるバージョンで同様に動作するか確認してみてください。バージョンによる動作の違いについては、本教科書の情報交換を行うSlackで情報共有したり、今後の本教科書のバージョンアップなどで対応していく予定です。

## アーキテクチャ
Linuxカーネルは様々な種類のCPUアーキテクチャに対応しています。アーキテクチャによってバイナリーが異なるため、アーキテクチャに合わせたISOイメージを選択する必要があります。主なアーキテクチャには以下のものがあります。

### x86_64
IntelやAMDのCPUアーキテクチャです。64ビット版になります。

### aarch64
ARMのCPUアーキテクチャです。64ビット版になります。

この他にPowerPC(ppc64le)や、IBM S/390(s390x)などのアーキテクチャに対応したISOイメージが用意されています。

## ISOイメージの種類
ISOイメージには、いくつかの種類があります。インストールの目的によってイメージを選択します。AlmaLinuxには以下の3種類のISOイメージが用意されています。

### boot.iso
インストーラーの起動のみを行うISOイメージです。インストールするファイルをネットワーク経由で取得するネットワークインストールを行います。システムに障害が発生した際に復旧を行うレスキューモードで起動するためにも使用できます。
最低限の構成になっているので、ISOイメージのサイズは小さくなっています。

### minimal.iso
最低限のOSインストールを行うISOイメージです。DVDメディアの容量制限に引っかからないため、DVDメディアを作成してインストールを行うにはこちらを選択します。

### dvd.iso
フルインストールが可能なISOイメージです。サイズが大きいため、DVDメディアを作成することができません。USBメモリに書き込むか、仮想マシンにインストールする場合には利用可能です。


本教科書の演習では、GUI環境も使用するため、フルインストールが可能なISOイメージ（dvd.iso）を使ってインストールします。AlmaLinux-9.2-x86_64-dvd.isoをダウンロードしてください。

実務では最小限のインストールを行い、必要なパッケージを追加してサーバーを構築することが多いので、慣れてきたら最低限のOSインストールを行うISOイメージ（minimal.iso）からインストールを行う方法にも挑戦してみてください。

# ネットワーク環境について
本教科書での実習ではサーバー間での接続のためにネットワークを利用します。ネットワークの設定項目は複数ありますので、あらかじめIPアドレスなどを決めておくとよいでしょう。

## 本教科書で想定しているネットワーク
ネットワークを自由に設定できる場合は、設定を間違えにくくするため、本教科書で用いているネットワークの設定を利用して下さい。

本教科書では、ネットワーク環境としてコンピューター実習教室を想定しています。教室にはPCが3台以上あり、講師用PCが1台と受講生用PCが2台以上あるとします。ネットワークは、講師用、受講生用PCの区別無く、すべてのPCが1つのネットワークに接続されていることを想定しています。

## 本教科書で想定しているIPアドレスを設定できない場合（非推奨）
利用するネットワークの各種設定情報が組織のネットワーク管理者から指示されている場合は、その指示に従ってIPアドレスなどを指定します。

本教科書で想定しているIPアドレスを、適宜指定されたIPアドレスに置き換えて設定してください。ただし、この方法は設定間違いを起こしやすいため、推奨されません。

# ネットワークの設定項目
## ドメイン名
ドメイン名は、DNSサーバーを設定するときに必要になります。このドメイン名は、あくまでこのネットワーク内のみで有効なドメイン名で、外部のDNSとは隔離された状態にあります。

本教科書では、受講生用にalpha.jpとbeta.jpの2つを使用します。受講生が3名以上の場合には、講師の指示に従ってドメイン名の指定を受けてください。

## ホスト名
自分のPCに設定するホスト名です。今回はhost受講生番号.ドメイン名とします。

受講生番号1と2の場合には

host1.alpha.jp
host2.beta.jp

となります。

## IPアドレス
IPアドレスは、講師用のIPアドレスを192.168.1.100、受講生のIPアドレスを192.168.1.101と192.168.1.102としています。

## サブネットマスク
サブネットマスクは、IPアドレスのネットワーク部とホスト部を分ける値です。本教科書では255.255.255.0(/24)とします。

## ネットワークアドレス
ネットワークアドレスは、PCが含まれているネットワーク全体を示すアドレスです。本教科書では192.168.1.0とします。

## デフォルトゲートウエイ
異なるサブネットとの通信に必要な値です。本教科書では192.168.1.1とします。

## DNSサーバーアドレス
ホスト名とIPアドレスの対応を解決する、DNS（ドメインネームシステム）という機構があります。DNSを利用するためにはDNSサーバーのIPアドレスが必要です。

本教科書ではx章で、実際にDNSサーバーを設定し動作させます。実習ではまず自分自身で動作させているDNSサーバーを参照するため、DNSサーバーアドレスを自分のIPアドレスとします。受講生番号1の場合には192.168.1.101、受講生番号2の場合には192.168.1.102となります。

# 高度なストレージ管理
ここでは、高度なストレージ管理としてLVM(Logical Volume Manager)とRAID(Redundant Arrays of Inexpensive Disks)について説明します。インストールを開始すると、ストレージをLVMで設定します。少々高度な内容になるため、インストール作業後に読んでもかまいません。

# LVM
Logical Volume Manager（LVM）は、ディスク管理操作を非常に便利にしてくれる仕組みです。
ストレージを利用する際には、ディスク内をいくつかの「パーティション」に分割します。パーティション分割作業はインストール時に行うため、事前に想定して容量を決める必要があります。そのため、後から容量が足りなくなってしまったり、多めに割り当てたらあまり利用されず未使用になってしまったといった問題が発生します。

しかし、パーティションを再分割することは非常に手間がかかります。ディスクの内容を一度全部消す必要があるからです。

LVMを用いると、パーティションを柔軟に取り扱うことができます。

## LVMの仕組み
LVMでは、以下のような仕組みを使ってディスクを管理します。

### PV(Physical Volume)  
ディスクの物理領域です。1つのパーティションだったり、ディスク1台丸ごとPVということもありえます。

### VG(Volume Group) 
一つ以上のPVの集まりがVolume Groupです。

### LV(Logical Volume) 
Volume Groupから、Logical Volume領域を確保して利用します。LVの領域にファイルシステムを作成して、ファイルやディレクトリなどのデータが格納されます。

LVは自由に容量を増やしたり減らしたりできます。LVの容量の合計は、確保元のVGの容量よりも大きくなることはありません。

VGの容量が不足した場合には、ディスクを追加するなどしてPVを

## LVMの利点
LVMを用いると、どんな点が便利なのでしょうか?実際にケーススタディで学習してみましょう。

### 容量を増やすのが容易
LVに保存したデータが増加し、割り当てたLVの容量では足りなくなった場合には、LVの容量を増やすことで対応可能です。使用しているファイルシステムによっては、OSを止めることなく容量を増やすこともできます。

### 容量を減らすことも可能
逆にLVの容量を大きく確保しすぎて余ってしまった場合には、ファイルシステムを縮めた後にLVの容量を減らすことができます。これでVGの未使用領域が増えるので、他のLVの容量を増やしたり、新しくLVを確保したりするときに利用できます。

### ディスクの増設が容易 
LVの利用率が増えてその元であるVGの空き容量が少なくなった場合、ディスクを増設する必要がありますが、LVMを用いると作業は簡単です。

ディスクを取り付けて、そのディスクをPVとします。そのPVをVGに追加すると、VG全体の容量が増えます。増えたVGから新しくLVを確保したり、既存のLVのサイズを増やしたりして利用できる領域を増やすことができます。

# RAID
RAIDとはRedundant Arrays of Inexpensive Disksの略で、ディスクの耐障害性を高めたり、機能を高めたりすることに用いられます。ディスクのアクセス性能を上げたい場合や、重要なデータを置いておく場合に利用します。

## RAIDの種類
RAIDにはその機能でさまざまな種類があります。ここでは広く用いられるRAID 0、1、1+0、5、6について説明します。

### RAID 0(ストライピング) 
2台以上のディスクを用意し、書き込み時にそれぞれのディスクに分散書き込みを行います。ディスクの処理が分散するので、読み書きの速度が高速になります。また、使用できるディスク容量はすべてのディスクの容量の合計となります。

欠点は、1台でもディスクが壊れるとすべてのデータが読み書きできなくなることです。

### RAID 1(ミラーリング) 
2台以上のディスクを用意し、それぞれに同じ内容を書き込みます。1台のディスクが壊れても、その他のディスクが正常であればデータは失われません。そのため、ディスク障害に強い構成を実現できます。

欠点は、利用できる容量がディスク1台の容量になってしまうことです。例えば容量1TBのディスクを2台用意しても、使用できる容量は1TBのままです。

### RAID1+0（ミラーリング＋ストライピング）
RAID 1+0はミラーリング(RAID 1)したディスクをストライピング(RAID 0)するRAIDの構成です。ストライピングの性能とミラーリングの冗長性の両方を得るためのRAIDです。ストライピングはディスクが1台でも壊れるとすべてのデータが失われてしまいますが、RAID 1+0ではミラーリングが行われているので、ディスクが1台壊れてもデータは失われません。ただし、ミラーリングされた両方のディスクが壊れてしまうと、通常のRAID 0と同様にデータは失われてしまいます。

欠点は、ディスクが最低でも4台必要であることと、ミラーリングされているため容量が半分になってしまうという点です。

### RAID 5(パリティ分散)
ディスクを3台以上用意し、パリティというデータを一緒に書き込むことでディスクの冗長化を図っています。ディスクが1台故障してもデータを失うことはありません。RAID 5は「1台あたりのディスク容量×(台数-1)」の容量が使えますので、ディスクの利用効率も良いことになります。たとえば1TBのディスクを3台用意すれば、合計2TBのディスク容量になります。

欠点は、ディスクが同時に2台以上壊れるとデータの復元ができないという点です。

### RAID 6（複数分散パリティ）
パリティを2重に計算し書き込むことで、ディスクが2台まで故障しても大丈夫にしたRAID構成です。

欠点は、パリティ用にディスク2台分の容量を消費する点が挙げられます。

### その他のRAID 
RAIDには、他にも2,3,4がありますが、あまり使われていません。

### JBOD
JBOD(Just a Bunch Of Disks)は、RAIDのようにデータをディスクに分散して書き込むのではなく、単にディスクを1つに繋いで大きな容量のディスクに見せる仕組みです。RAID 0に似ていますが、RAID 0は構成するディスクの容量を同じにするか、容量が少ない方に合わせる必要があるのに対して、JBODは異なる容量のディスクを使うことができます。

また、RAID 0はディスク障害が起きるとすべてのデータが読み出せなくなるのに対して、JBODは障害が起きていないディスクに書き込まれたデータは読み出せる可能性があります。ただし、信頼性においてはRAID 5に劣るので、できるだけ沢山の容量が必要で、確実にバックアップが行われていてデータを復元できるような場合に使う仕組みです。

## ハードウェアRAIDとソフトウェアRAID
RAIDではハードウェアRAIDとソフトウェアRAIDが存在します。

### ハードウェアRAID 
ハードウェアRAIDは、RAIDの処理をハードウェア（RAIDコントローラ）が行います。ハードウェアRAIDはOSや本体のハードウェアに負荷がかからないので、RAID 5やRAID 6のようなパリティを計算する必要があるRAID構成を取りやすくなります。

欠点は、特別なハードウェアが必要で費用がかかることや、RAIDコントローラ用のドライバーが必要な点が挙げられます。インストール時にドライバーが無いと、RAIDコントローラーに接続されたディスクは認識されず、インストールが行えません。

### ソフトウェアRAID 
ソフトウェアRAIDは、OSがRAIDの処理を行います。ソフトウェアRAIDはRAIDコントローラが必要ないため、コストを抑えてRAIDを組むことができます。

欠点は、ハードウェアRAIDと比べてOS、ハードウェア（特にCPU）に負荷がかかる点が挙げられます。

# 高度なストレージの利用例
Linuxでは、ディスクを使用するためにはパーティションやLVにファイルシステムを作成して、特定のディレクトリにマウントします。インストーラーが自動的に行うデフォルトの構成ではLVが一つ作成され、すべてのディレクトリの大元となるルートディレクトリ（”/”）としてマウントします。そのサブディレクトリとして/varや/homeといったディレクトリが作成されます。

/varは、ログファイルなどシステムが様々なデータを書き出します。/homeは、ユーザーが作成したデータが置かれます。この2つのディレクトリは利用量が非常に変化しやすいディレクトリなので、LVMを用いて可変としたり、RAIDを用いて冗長化されるよう構成することが望ましいと言えます。
